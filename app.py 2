import json
import datetime
import streamlit as st

# --- 2. GEST√ÉO DE DADOS E ARSENAL (SISTEMA DE AKASHA) ---

# Banco de Dados de Equipamentos (Grounding: Realidade do Interno/Atleta)
EQUIPMENT_DB = {
    "Assinatura de Banco de Quest√µes": {"slot": "head", "bonus_int": 2, "xp_mult": 0.15, "desc": "+15% XP em Estudos"},
    "T√™nis de Plant√£o": {"slot": "body", "hp_max": 20, "desc": "+20 HP M√°ximo"},
    "Estetosc√≥pio de Elite": {"slot": "hands", "bonus_sen": 5, "desc": "+5 Percep√ß√£o Cl√≠nica"},
    "Cinto de LPO / Straps": {"slot": "hands", "bonus_str": 5, "desc": "+5 For√ßa nos Treinos"},
    "Manual de Condutas": {"slot": "accessory", "mp_reduction": 5, "desc": "-5 MP de custo em INT"},
    "Smartwatch Pro": {"slot": "accessory", "coin_mult": 0.10, "desc": "+10% Moedas ganhas"},
    "Gal√£o de Hidrata√ß√£o": {"slot": "accessory", "bonus_vit": 3, "desc": "+3 Vitalidade (Hidrata√ß√£o)"}
}

def get_rank_info(level):
    """Define a aura, a cor e o T√≠tulo do Monarca baseado no n√≠vel"""
    if level < 10: 
        return {"name": "E", "color": "#9e9e9e", "glow": "rgba(158, 158, 158, 0.5)", "title": "Interno Novato"}
    if level < 20: 
        return {"name": "D", "color": "#4caf50", "glow": "rgba(76, 175, 80, 0.5)", "title": "Interno Veterano"}
    if level < 30: 
        return {"name": "C", "color": "#2196f3", "glow": "rgba(33, 150, 243, 0.5)", "title": "Residente Aspirante"}
    if level < 40: 
        return {"name": "B", "color": "#9c27b0", "glow": "rgba(156, 39, 176, 0.5)", "title": "Mestre da Cl√≠nica"}
    if level < 50: 
        return {"name": "A", "color": "#ff5722", "glow": "rgba(255, 87, 34, 0.5)", "title": "Monarca Hospitalar"}
    return {"name": "S", "color": "#ffcc00", "glow": "rgba(255, 204, 0, 0.6)", "title": "Soberano da Medicina"}

def get_initial_data():
    """Gera o estado inicial de um Ca√ßador com Invent√°rio Vazio"""
    return {
        "lvl": 1, "xp": 0, "hp": 100, "mp": 100, "coins": 0, "points": 0,
        "last_access": str(datetime.date.today()),
        "stats": {"STR": 10, "INT": 10, "AGI": 10, "VIT": 10, "CHA": 10, "SEN": 10},
        "inventory": [],  # Lista de nomes dos itens comprados
        "equipped": {"head": None, "body": None, "hands": None, "accessory": None}, # Itens ativos
        "history": []
    }

# Inicializa√ß√£o segura
if 'data' not in st.session_state:
    st.session_state.data = get_initial_data()

# Fun√ß√£o para calcular Atributos Totais (Base + Equipamentos)
def get_total_stats():
    total = st.session_state.data["stats"].copy()
    hp_extra = 0
    equipped = st.session_state.data["equipped"]
    
    for slot, item_name in equipped.items():
        if item_name in EQUIPMENT_DB:
            item = EQUIPMENT_DB[item_name]
            total["STR"] += item.get("bonus_str", 0)
            total["INT"] += item.get("bonus_int", 0)
            total["VIT"] += item.get("bonus_vit", 0)
            total["SEN"] += item.get("bonus_sen", 0)
            hp_extra += item.get("hp_max", 0)
    return total, hp_extra

# Carrega Rank e Aura
rank_info = get_rank_info(st.session_state.data["lvl"])

# Inje√ß√£o de Estilo (Aura Din√¢mica)
st.markdown(f"""
    <style>
    h1, h2, h3 {{ color: {rank_info['color']} !important; text-shadow: 0 0 10px {rank_info['glow']} !important; }}
    .stButton>button {{ border-color: {rank_info['color']} !important; color: {rank_info['color']} !important; }}
    .stButton>button:hover {{ background-color: {rank_info['color']} !important; color: black !important; box-shadow: 0 0 20px {rank_info['color']} !important; }}
    div[st-ui="stProgress"] > div > div > div {{ background-color: {rank_info['color']} !important; }}
    </style>
    """, unsafe_allow_html=True)

# L√≥gica de Tempo e Regenera√ß√£o
hoje = str(datetime.date.today())
if st.session_state.data.get("last_access") != hoje:
    st.session_state.data["mp"] = 100 
    st.session_state.data["hp"] = min(100, st.session_state.data["hp"] + 20)
    st.session_state.data["last_access"] = hoje
    st.toast(f"‚òÄÔ∏è Bom plant√£o, {rank_info['title']}! Energias restauradas.", icon="üî∑")

# --- PARTE 3: L√ìGICA DE CARREGAMENTO BLINDADA ---
    if uploaded_file is not None:
        try:
            temp_data = json.load(uploaded_file)
            
            # MIGRATION LOGIC: Se o save for antigo, adicionamos os novos sistemas
            if "inventory" not in temp_data:
                temp_data["inventory"] = []
            if "equipped" not in temp_data:
                temp_data["equipped"] = {"head": None, "body": None, "hands": None, "accessory": None}
            
            # Valida√ß√£o padr√£o
            if "lvl" in temp_data and "stats" in temp_data:
                st.session_state.data = temp_data
                st.success("Sincroniza√ß√£o com Akasha Conclu√≠da! Save antigo atualizado.")
                st.rerun()
            else:
                st.error("Assinatura Inv√°lida!")
        except Exception as e:
            st.error(f"Erro na restaura√ß√£o: {e}")

      def get_total_stats():
    # .get() evita o KeyError se a chave n√£o existir
    stats_base = st.session_state.data.get("stats", {}).copy()
    equipped = st.session_state.data.get("equipped", {})
    hp_extra = 0
    
    # Se por algum motivo as chaves sumirem, o c√≥digo n√£o quebra
    if not stats_base:
        return {"STR": 10, "INT": 10, "AGI": 10, "VIT": 10, "CHA": 10, "SEN": 10}, 0

    for slot, item_name in equipped.items():
        if item_name in EQUIPMENT_DB:
            item = EQUIPMENT_DB[item_name]
            stats_base["STR"] += item.get("bonus_str", 0)
            stats_base["INT"] += item.get("bonus_int", 0)
            stats_base["VIT"] += item.get("bonus_vit", 0)
            stats_base["SEN"] += item.get("bonus_sen", 0)
            hp_extra += item.get("hp_max", 0)
            
    return stats_base, hp_extra
